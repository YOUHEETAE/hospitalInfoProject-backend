name: EC2 ë°°í¬ (DuckDNS + ëª¨ë‹ˆí„°ë§) test

on:
  push:
    branches: [ test ]
  workflow_dispatch:

env:
  DEV_EC2_HOST: ${{ secrets.DEV_EC2_HOST }}
  EC2_USER: ${{ secrets.EC2_USER }}
  EC2_KEY: ${{ secrets.EC2_PRIVATE_KEY }}

jobs:
  build-and-deploy:
    name: ë¹Œë“œ ë° ë°°í¬
    runs-on: ubuntu-latest
    
    steps:
    - name: ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v3
      
    - name: Docker Buildx ì„¤ì •
      uses: docker/setup-buildx-action@v2
      
    - name: ë°±ì—”ë“œ ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ
      run: |
        cd hospital_main
        echo "ğŸ”¨ ë°±ì—”ë“œ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
        docker build --no-cache -t hospital-backend:${{ github.sha }} .
        docker tag hospital-backend:${{ github.sha }} hospital-backend:latest
        echo "âœ… ë°±ì—”ë“œ ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ"
        
    - name: ë„ì»¤ ì´ë¯¸ì§€ ì••ì¶• ë° ì €ì¥
      run: |
        echo "ğŸ’¾ Docker ì´ë¯¸ì§€ ì••ì¶• ì¤‘..."
        docker save hospital-backend:latest | gzip > backend.tar.gz
        
        # ì´ë¯¸ì§€ í¬ê¸° í™•ì¸
        ls -lh *.tar.gz
        echo "âœ… ì´ë¯¸ì§€ ì••ì¶• ì™„ë£Œ"
        
    - name: ë°°í¬ íŒŒì¼ë“¤ì„ EC2 ì„œë²„ë¡œ ì „ì†¡
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.DEV_EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        source: "backend.tar.gz,docker-compose.yml,deploy-test.sh"
        target: "/home/ec2-user/"
        
    - name: EC2 ì„œë²„ì— DuckDNS + ëª¨ë‹ˆí„°ë§ ë°°í¬
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.DEV_EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        envs: GITHUB_SHA
        script: |
          echo "ğŸš€ ë³‘ì› í”„ë¡œì íŠ¸ DuckDNS + ëª¨ë‹ˆí„°ë§ ë°°í¬ ì‹œì‘..."
          
          # Docker ì´ë¯¸ì§€ ë¡œë“œ
          echo "ğŸ“¦ Docker ì´ë¯¸ì§€ ë¡œë“œ ì¤‘..."
          docker load < /home/ec2-user/backend.tar.gz
          
          # í•„ìš”í•œ ë””ë ‰í† ë¦¬ ìƒì„±
          sudo mkdir -p /opt/hospital/config/duckdns
          sudo mkdir -p /opt/hospital/config/prometheus
          sudo mkdir -p /opt/hospital/monitoring/prometheus/config
          sudo mkdir -p /opt/hospital/monitoring/prometheus/data
          sudo mkdir -p /opt/hospital/monitoring/grafana/data
          sudo mkdir -p /opt/hospital/monitoring/grafana/provisioning/dashboards
          sudo mkdir -p /opt/hospital/monitoring/grafana/provisioning/datasources
          sudo chown -R ec2-user:ec2-user /opt/hospital/
          
          # .env íŒŒì¼ ìƒì„±
          cat > .env << EOF
          ENVIRONMENT=production
          IMAGE_TAG=latest
          
          # ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •
          DB_ROOT_PASSWORD=${{ secrets.DB_ROOT_PASSWORD }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_PORT=3500
          
          # ë°±ì—”ë“œ ì„¤ì •
          BACKEND_HOST=hospital-backend
          BACKEND_PORT=8888
          
          # DuckDNS ì„¤ì •
          DEV_DUCKDNS_DOMAIN=${{ secrets.DEV_DUCKDNS_DOMAIN }}
          DEV_DUCKDNS_SUBDOMAIN=${{ secrets.DEV_DUCKDNS_SUBDOMAIN }}
          DUCKDNS_TOKEN=${{ secrets.DUCKDNS_TOKEN }}
          
          # ëª¨ë‹ˆí„°ë§ ì„¤ì •
          PROMETHEUS_PORT=9090
          GRAFANA_PORT=3000
          GRAFANA_ADMIN_USER=admin
          GRAFANA_ADMIN_PASSWORD=${{ secrets.GRAFANA_ADMIN_PASSWORD }}
          
          # ë³‘ì›/ì•½êµ­ API í‚¤ ì„¤ì •
          HOSPITAL_MAIN_API_KEY=${{ secrets.HOSPITAL_MAIN_API_KEY }}
          HOSPITAL_DETAIL_API_KEY=${{ secrets.HOSPITAL_DETAIL_API_KEY }}
          HOSPITAL_MEDICAL_SUBJECT_API_KEY=${{ secrets.HOSPITAL_MEDICAL_SUBJECT_API_KEY }}
          HOSPITAL_PRODOC_API_KEY=${{ secrets.HOSPITAL_PRODOC_API_KEY }}
          HOSPITAL_PHARMACY_API_KEY=${{ secrets.HOSPITAL_PHARMACY_API_KEY }}
          HOSPITAL_EMERGENCY_API_KEY=${{ secrets.HOSPITAL_EMERGENCY_API_KEY }}
          API_ADMIN_KEY=${{ secrets.API_ADMIN_KEY }}
          
          # ë³‘ì›/ì•½êµ­ API Base URL ì„¤ì •
          HOSPITAL_MAIN_API_BASE_URL=${{ secrets.HOSPITAL_MAIN_API_BASE_URL }}
          HOSPITAL_DETAIL_API_BASE_URL=${{ secrets.HOSPITAL_DETAIL_API_BASE_URL }}
          HOSPITAL_MEDICAL_SUBJECT_API_BASE_URL=${{ secrets.HOSPITAL_MEDICAL_SUBJECT_API_BASE_URL }}
          HOSPITAL_PRODOC_API_BASE_URL=${{ secrets.HOSPITAL_PRODOC_API_BASE_URL }}
          HOSPITAL_PHARMACY_API_BASE_URL=${{ secrets.HOSPITAL_PHARMACY_API_BASE_URL }}
          HOSPITAL_EMERGENCY_API_BASE_URL=${{ secrets.HOSPITAL_EMERGENCY_API_BASE_URL }}
          
          # ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •
          DB_URL=${{ secrets.DB_URL }}
          DB_USERNAME=${{ secrets.DB_USERNAME }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          
          EOF
          
          # Docker Composeìš© Prometheus ì„¤ì • íŒŒì¼ ìƒì„± (ìƒˆë¡œ ì¶”ê°€)
          cat > /opt/hospital/config/prometheus/prometheus.yml << 'EOF'
          global:
            scrape_interval: 15s
            evaluation_interval: 15s
            external_labels:
              cluster: 'hospital-production'
              environment: 'prod'
          
          rule_files:
            - "alert_rules.yml"
          
          alerting:
            alertmanagers:
              - static_configs:
                  - targets: []
          
          scrape_configs:
            - job_name: 'prometheus'
              static_configs:
                - targets: ['localhost:9090']
              scrape_interval: 15s
          
            - job_name: 'hospital-backend'
              static_configs:
                - targets: ['backend:8888']
              metrics_path: '/actuator/prometheus'
              scrape_interval: 15s
              scrape_timeout: 10s
          
            - job_name: 'node-exporter'
              static_configs:
                - targets: ['node-exporter:9100']
              scrape_interval: 15s
          
            - job_name: 'cadvisor'
              static_configs:
                - targets: ['cadvisor:8080']
              scrape_interval: 15s
          EOF
          
          # ê¸°ì¡´ ëª¨ë‹ˆí„°ë§ ìŠ¤íƒìš© í”„ë¡œë©”í…Œìš°ìŠ¤ ì„¤ì • íŒŒì¼ ìƒì„± (ìˆ˜ì •ëœ ë²„ì „)
          cat > /opt/hospital/monitoring/prometheus/config/prometheus.yml << 'PROMETHEUS_CONFIG'
          global:
            scrape_interval: 15s
            evaluation_interval: 15s
            external_labels:
              cluster: 'hospital-production'
              environment: 'prod'
          
          rule_files:
            - "alert_rules.yml"
          
          alerting:
            alertmanagers:
              - static_configs:
                  - targets: []
          
          scrape_configs:
            - job_name: 'prometheus'
              static_configs:
                - targets: ['localhost:9090']
              scrape_interval: 15s
          
            - job_name: 'hospital-backend'
              static_configs:
                - targets: ['hospital-backend:8888']
              metrics_path: '/actuator/prometheus'
              scrape_interval: 15s
              scrape_timeout: 10s
          
            - job_name: 'node-exporter'
              static_configs:
                - targets: ['node-exporter:9100']
              scrape_interval: 15s
          
            - job_name: 'cadvisor'
              static_configs:
                - targets: ['cadvisor:8080']
              scrape_interval: 15s
          PROMETHEUS_CONFIG
          
          # í”„ë¡œë©”í…Œìš°ìŠ¤ ì•Œë¦¼ ê·œì¹™ ìƒì„±
          cat > /opt/hospital/monitoring/prometheus/config/alert_rules.yml << 'ALERT_RULES'
          groups:
            - name: hospital_backend_alerts
              rules:
                - alert: BackendDown
                  expr: up{job="hospital-backend"} == 0
                  for: 1m
                  labels:
                    severity: critical
                  annotations:
                    summary: "Hospital Backend is down"
                    description: "Hospital Backend has been down for more than 1 minute"
          
                - alert: HighCPUUsage
                  expr: system_cpu_usage > 0.8
                  for: 2m
                  labels:
                    severity: warning
                  annotations:
                    summary: "High CPU usage detected"
                    description: "CPU usage is above 80% for more than 2 minutes"
          
                - alert: HighMemoryUsage
                  expr: jvm_memory_used_bytes / jvm_memory_max_bytes > 0.8
                  for: 2m
                  labels:
                    severity: warning
                  annotations:
                    summary: "High JVM memory usage"
                    description: "JVM memory usage is above 80% for more than 2 minutes"
          
            - name: infrastructure_alerts
              rules:
                - alert: NodeDown
                  expr: up{job="node-exporter"} == 0
                  for: 1m
                  labels:
                    severity: critical
                  annotations:
                    summary: "Node Exporter is down"
                    description: "Node Exporter has been down for more than 1 minute"
          
                - alert: DiskSpaceHigh
                  expr: (node_filesystem_avail_bytes / node_filesystem_size_bytes) < 0.1
                  for: 2m
                  labels:
                    severity: warning
                  annotations:
                    summary: "Disk space usage high"
                    description: "Disk space usage is above 90%"
          ALERT_RULES
          
          # ê·¸ë¼íŒŒë‚˜ ë°ì´í„°ì†ŒìŠ¤ ì„¤ì • íŒŒì¼ ìƒì„±
          cat > /opt/hospital/monitoring/grafana/provisioning/datasources/prometheus.yml << 'DATASOURCE_CONFIG'
          apiVersion: 1
          
          datasources:
            - name: Prometheus
              type: prometheus
              access: proxy
              url: http://prometheus:9090
              isDefault: true
              editable: true
          DATASOURCE_CONFIG
          
          # ê·¸ë¼íŒŒë‚˜ ëŒ€ì‹œë³´ë“œ í”„ë¡œë¹„ì €ë‹ ì„¤ì •
          cat > /opt/hospital/monitoring/grafana/provisioning/dashboards/dashboard.yml << 'DASHBOARD_CONFIG'
          apiVersion: 1
          
          providers:
            - name: 'default'
              orgId: 1
              folder: ''
              type: file
              disableDeletion: false
              updateIntervalSeconds: 10
              allowUiUpdates: true
              options:
                path: /var/lib/grafana/dashboards
          DASHBOARD_CONFIG
           
          # í™˜ê²½ë³€ìˆ˜ í™•ì¸
          echo "ğŸ“‹ ë°°í¬ í™˜ê²½ ì„¤ì •:"
          echo "  í™˜ê²½: production"
          echo "  DuckDNS ë„ë©”ì¸: ${{ secrets.DEV_DUCKDNS_DOMAIN }}"
          echo "  DuckDNS ì„œë¸Œë„ë©”ì¸: ${{ secrets.DEV_DUCKDNS_SUBDOMAIN }}"
          echo "  ë°±ì—”ë“œ í¬íŠ¸: 8888"
          echo "  DB í¬íŠ¸: 3500"
          echo "  í”„ë¡œë©”í…Œìš°ìŠ¤ í¬íŠ¸: 9090"
          echo "  ê·¸ë¼íŒŒë‚˜ í¬íŠ¸: 3000"
          
          # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
          chmod +x /home/ec2-user/deploy-test.sh
          
          # ë°°í¬ ì‹¤í–‰
          echo "â–¶ï¸ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰..."
          /home/ec2-user/deploy-test.sh
          
          # ëª¨ë‹ˆí„°ë§ ìŠ¤íƒ ì„¤ì¹˜
          echo "ğŸ“Š ëª¨ë‹ˆí„°ë§ ìŠ¤íƒ ì„¤ì¹˜ ì¤‘..."
          
          # Docker ë„¤íŠ¸ì›Œí¬ê°€ ì—†ë‹¤ë©´ ìƒì„±
          docker network ls | grep hospital-network || docker network create hospital-network
          
          # ê¸°ì¡´ ëª¨ë‹ˆí„°ë§ ì»¨í…Œì´ë„ˆ ì •ë¦¬
          docker stop cadvisor node-exporter prometheus grafana 2>/dev/null || true
          docker rm cadvisor node-exporter prometheus grafana 2>/dev/null || true
          
          # cAdvisor ì‹¤í–‰ (ì»¨í…Œì´ë„ˆ ëª¨ë‹ˆí„°ë§)
          docker run -d \
            --name cadvisor \
            --restart unless-stopped \
            --network hospital-network \
            -p 8080:8080 \
            -v /:/rootfs:ro \
            -v /var/run:/var/run:rw \
            -v /sys:/sys:ro \
            -v /var/lib/docker/:/var/lib/docker:ro \
            --privileged \
            --device /dev/kmsg \
            gcr.io/cadvisor/cadvisor:latest || echo "âš ï¸ cAdvisor ì‹œì‘ ì‹¤íŒ¨ (ê³„ì† ì§„í–‰)"
          
          # Node Exporter ì‹¤í–‰
          docker run -d \
            --name node-exporter \
            --restart unless-stopped \
            --network hospital-network \
            -p 9100:9100 \
            -v /proc:/host/proc:ro \
            -v /sys:/host/sys:ro \
            -v /:/rootfs:ro \
            --pid host \
            prom/node-exporter:latest \
            --path.procfs=/host/proc \
            --path.rootfs=/rootfs \
            --path.sysfs=/host/sys \
            --collector.filesystem.mount-points-exclude='^/(sys|proc|dev|host|etc)($$|/)'
          
          # í”„ë¡œë©”í…Œìš°ìŠ¤ ì‹¤í–‰
          docker run -d \
            --name prometheus \
            --restart unless-stopped \
            --network hospital-network \
            -p 9090:9090 \
            -v /opt/hospital/monitoring/prometheus/config:/etc/prometheus \
            -v /opt/hospital/monitoring/prometheus/data:/prometheus \
            --user "$(id -u):$(id -g)" \
            prom/prometheus:latest \
            --config.file=/etc/prometheus/prometheus.yml \
            --storage.tsdb.path=/prometheus \
            --web.console.libraries=/etc/prometheus/console_libraries \
            --web.console.templates=/etc/prometheus/consoles \
            --storage.tsdb.retention.time=200h \
            --web.enable-lifecycle \
            --web.enable-admin-api
          
          # ê·¸ë¼íŒŒë‚˜ ì‹¤í–‰
          docker run -d \
            --name grafana \
            --restart unless-stopped \
            --network hospital-network \
            -p 3000:3000 \
            -v /opt/hospital/monitoring/grafana/data:/var/lib/grafana \
            -v /opt/hospital/monitoring/grafana/provisioning:/etc/grafana/provisioning \
            -e GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin} \
            -e GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin} \
            -e GF_INSTALL_PLUGINS=grafana-piechart-panel,grafana-worldmap-panel,grafana-clock-panel \
            -e GF_USERS_ALLOW_SIGN_UP=false \
            --user "$(id -u):$(id -g)" \
            grafana/grafana:latest
          
          sleep 15
          
          echo "âœ… ëª¨ë‹ˆí„°ë§ ìŠ¤íƒ ì„¤ì¹˜ ì™„ë£Œ!"
          
          # ì„ì‹œ íŒŒì¼ ì •ë¦¬
          echo "ğŸ§¹ ì„ì‹œ íŒŒì¼ ì •ë¦¬..."
          rm -f /home/ec2-user/*.tar.gz
          
          echo "âœ… ë°°í¬ ì™„ë£Œ!"
          
    - name: ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ ë° í—¬ìŠ¤ì²´í¬
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.DEV_EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        script: |
          echo "ğŸ¥ ì„œë¹„ìŠ¤ í—¬ìŠ¤ì²´í¬ ì‹œì‘..."
          
          # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
          echo "ğŸ“Š ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
          docker-compose -f /home/ec2-user/docker-compose.yml ps
          
          echo ""
          echo "ğŸ“Š ëª¨ë‹ˆí„°ë§ ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
          docker ps --filter name=prometheus --filter name=grafana --filter name=node-exporter --filter name=cadvisor
          
          # DuckDNS ë„ë©”ì¸ìœ¼ë¡œ ë°±ì—”ë“œ API í™•ì¸
          TARGET_URL="http://${{ secrets.DEV_DUCKDNS_DOMAIN }}:8888"
          echo "ğŸ” ë°±ì—”ë“œ API ì‘ë‹µ í…ŒìŠ¤íŠ¸ ($TARGET_URL)..."
          
          BACKEND_OK=false
          for i in {1..2}; do
            echo "  ì‹œë„ $i/12..."
            
            if curl -f -s --connect-timeout 10 "$TARGET_URL/api/proDoc/status" > /dev/null 2>&1; then
              echo "âœ… ë°±ì—”ë“œ API: ì •ìƒ"
              BACKEND_OK=true
              break
            else
              echo "â³ ë°±ì—”ë“œ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
              sleep 10
            fi
          done
          
          # ëª¨ë‹ˆí„°ë§ í—¬ìŠ¤ì²´í¬
          PROMETHEUS_URL="http://${{ secrets.DEV_DUCKDNS_DOMAIN }}:9090"
          echo "ğŸ” í”„ë¡œë©”í…Œìš°ìŠ¤ í—¬ìŠ¤ì²´í¬ ($PROMETHEUS_URL)..."
          
          PROMETHEUS_OK=false
          for i in {1..3}; do
            if curl -f -s --connect-timeout 10 "$PROMETHEUS_URL/-/healthy" > /dev/null 2>&1; then
              echo "âœ… í”„ë¡œë©”í…Œìš°ìŠ¤: ì •ìƒ"
              PROMETHEUS_OK=true
              break
            else
              echo "â³ í”„ë¡œë©”í…Œìš°ìŠ¤ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
              sleep 10
            fi
          done
          
          # ê·¸ë¼íŒŒë‚˜ í—¬ìŠ¤ì²´í¬
          GRAFANA_URL="http://${{ secrets.DEV_DUCKDNS_DOMAIN }}:3000"
          echo "ğŸ” ê·¸ë¼íŒŒë‚˜ í—¬ìŠ¤ì²´í¬ ($GRAFANA_URL)..."
          
          GRAFANA_OK=false
          for i in {1..3}; do
            if curl -f -s --connect-timeout 10 "$GRAFANA_URL/api/health" > /dev/null 2>&1; then
              echo "âœ… ê·¸ë¼íŒŒë‚˜: ì •ìƒ"
              GRAFANA_OK=true
              break
            else
              echo "â³ ê·¸ë¼íŒŒë‚˜ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
              sleep 10
            fi
          done
          
          # ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í™•ì¸ (docker-composeë¡œ ì‹¤í–‰ëœ ê²½ìš°)
          if docker ps | grep hospital-mariadb > /dev/null; then
            echo "âœ… ë°ì´í„°ë² ì´ìŠ¤: ì •ìƒ"
          elif docker ps | grep mariadb > /dev/null; then
            echo "âœ… ë°ì´í„°ë² ì´ìŠ¤: ì •ìƒ (ì¼ë°˜ ì´ë¦„)"
          else
            echo "âš ï¸ ë°ì´í„°ë² ì´ìŠ¤: í™•ì¸ í•„ìš” (ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ)"
          fi
          
          # DuckDNS ì»¨í…Œì´ë„ˆ í™•ì¸
          if docker ps | grep hospital-duckdns > /dev/null; then
            echo "âœ… DuckDNS ìë™ ì—…ë°ì´íŠ¸: í™œì„±í™”"
            docker logs hospital-duckdns-dev --tail=5 2>/dev/null || docker logs hospital-duckdns --tail=5 2>/dev/null || echo "  ë¡œê·¸ í™•ì¸ ë¶ˆê°€"
          elif docker ps | grep duckdns > /dev/null; then
            echo "âœ… DuckDNS ìë™ ì—…ë°ì´íŠ¸: í™œì„±í™” (ì¼ë°˜ ì´ë¦„)"
          else
            echo "âš ï¸ DuckDNS ìë™ ì—…ë°ì´íŠ¸: ë¹„í™œì„±í™”"
          fi
          
          # Node Exporter í™•ì¸
          if docker ps | grep node-exporter > /dev/null; then
            echo "âœ… Node Exporter: ì •ìƒ"
          else
            echo "âš ï¸ Node Exporter: í™•ì¸ í•„ìš”"
          fi
          
          # cAdvisor í™•ì¸
          if docker ps | grep cadvisor > /dev/null; then
            echo "âœ… cAdvisor: ì •ìƒ"
          else
            echo "âš ï¸ cAdvisor: í™•ì¸ í•„ìš”"
          fi
          
          # ìµœì¢… ê²°ê³¼ ì¶œë ¥
          echo ""
          echo "ğŸ‰ =========================================="
          echo "    ë°±ì—”ë“œ ë°°í¬ ë° í—¬ìŠ¤ì²´í¬ ì™„ë£Œ!"
          echo "==========================================="
          echo ""
          echo "ğŸ“ ì ‘ì† ì •ë³´:"
          echo "  ğŸ”§ ë°±ì—”ë“œ API: http://${{ secrets.DEV_DUCKDNS_DOMAIN }}:8888"
          echo "  ğŸ“Š í”„ë¡œë©”í…Œìš°ìŠ¤: http://${{ secrets.DEV_DUCKDNS_DOMAIN }}:9090"
          echo "  ğŸ“ˆ ê·¸ë¼íŒŒë‚˜: http://${{ secrets.DEV_DUCKDNS_DOMAIN }}:3000"
          echo "  ğŸ–¥ï¸ Node Exporter: http://${{ secrets.DEV_DUCKDNS_DOMAIN }}:9100"
          echo "  ğŸ“¦ cAdvisor: http://${{ secrets.DEV_DUCKDNS_DOMAIN }}:8080"
          echo "  ğŸŒ DuckDNS ë„ë©”ì¸: ${{ secrets.DEV_DUCKDNS_DOMAIN }}"
          echo "  ğŸ“Š ë°ì´í„°ë² ì´ìŠ¤: í¬íŠ¸ 3500 (ë‚´ë¶€ ì ‘ê·¼)"
          echo ""
          echo "ğŸ”§ API í…ŒìŠ¤íŠ¸ ì˜ˆì‹œ:"
          echo "  curl http://${{ secrets.DEV_DUCKDNS_DOMAIN }}:8888/api/proDoc/status"
          echo "  curl http://${{ secrets.DEV_DUCKDNS_DOMAIN }}:8888/api/list"
          echo ""
          echo "ğŸ“Š ëª¨ë‹ˆí„°ë§ ì ‘ì† ì •ë³´:"
          echo "  í”„ë¡œë©”í…Œìš°ìŠ¤: http://${{ secrets.DEV_DUCKDNS_DOMAIN }}:9090"
          echo "  ê·¸ë¼íŒŒë‚˜: http://${{ secrets.DEV_DUCKDNS_DOMAIN }}:3000"
          echo "    - ì‚¬ìš©ì: admin"
          echo "    - ë¹„ë°€ë²ˆí˜¸: \${GRAFANA_ADMIN_PASSWORD} (ì„¤ì •ëœ ê°’)"
          echo ""
          echo "âœ¨ DuckDNS ìë™ IP ì—…ë°ì´íŠ¸ì™€ ì™„ì „í•œ ëª¨ë‹ˆí„°ë§ ìŠ¤íƒì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤!"
          
    - name: ë°°í¬ ì‹¤íŒ¨ ì‹œ ë¡¤ë°± ì²˜ë¦¬
      if: failure()
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.DEV_EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        script: |
          echo "âŒ ë°°í¬ ì‹¤íŒ¨! ë¡¤ë°± ì‹œë„..."
          
          # ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ì»¨í…Œì´ë„ˆ ì¤‘ì§€
          docker-compose -f /home/ec2-user/docker-compose.yml down || true
          
          # ëª¨ë‹ˆí„°ë§ ì»¨í…Œì´ë„ˆ ì¤‘ì§€
          docker stop prometheus grafana node-exporter cadvisor 2>/dev/null || true
          docker rm prometheus grafana node-exporter cadvisor 2>/dev/null || true
          
          # ìµœê·¼ ë¡œê·¸ í™•ì¸
          echo "ğŸ“ ìµœê·¼ ë¡œê·¸:"
          docker-compose -f /home/ec2-user/docker-compose.yml logs --tail=50 || echo "docker-compose ë¡œê·¸ í™•ì¸ ë¶ˆê°€"
          
          # ê°œë³„ ì»¨í…Œì´ë„ˆ ë¡œê·¸ í™•ì¸
          echo "ğŸ“ ê°œë³„ ì»¨í…Œì´ë„ˆ ë¡œê·¸:"
          docker logs hospital-backend-dev --tail=20 2>/dev/null || echo "ë°±ì—”ë“œ ë¡œê·¸ ì—†ìŒ"
          
          # ì„ì‹œ íŒŒì¼ ì •ë¦¬
          rm -f /home/ec2-user/*.tar.gz
          
          echo "ğŸ”„ ì´ì „ ë²„ì „ìœ¼ë¡œ ë¡¤ë°±í•˜ê±°ë‚˜ ìˆ˜ë™ìœ¼ë¡œ ë¬¸ì œë¥¼ í•´ê²°í•˜ì„¸ìš”."
