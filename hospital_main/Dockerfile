# ë¹Œë“œ ìŠ¤í…Œì´ì§€
FROM maven:3.9-amazoncorretto-21 AS builder

WORKDIR /app

# pom.xml ë¨¼ì € ë³µì‚¬ (ì˜ì¡´ì„± ìºì‹±)
COPY pom.xml .
RUN mvn dependency:go-offline -B

# ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬
COPY src ./src

# db.properties íŒŒì¼ ìˆ˜ì • (íŒŒì¼ì´ ì¡´ì¬í•˜ëŠ” ê²½ìš°ë§Œ)
RUN if [ -f "src/main/resources/db.properties" ]; then \
Â  Â  Â  Â  echo "=== db.properties ìˆ˜ì • ì „ ===" && \
Â  Â  Â  Â  cat src/main/resources/db.properties && \
Â  Â  Â  Â  sed -i 's/localhost:3500/mariadb:3500/g' src/main/resources/db.properties && \
Â  Â  Â  Â  echo "=== db.properties ìˆ˜ì • í›„ ===" && \
Â  Â  Â  Â  cat src/main/resources/db.properties; \
Â  Â  else \
Â  Â  Â  Â  echo "db.properties íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."; \
Â  Â  fi

# Maven ë¹Œë“œ
RUN echo "=== Maven ë¹Œë“œ ì‹œì‘ ===" && \
Â  Â  mvn clean package -DskipTests -B

# ë¹Œë“œ ê²°ê³¼ í™•ì¸
RUN echo "=== ë¹Œë“œ ê²°ê³¼ ===" && \
Â  Â  ls -la target/ && \
Â  Â  find target/ -name "*.war" -type f

# ì‹¤í–‰ ìŠ¤í…Œì´ì§€
FROM tomcat:10.1-jdk21-openjdk-slim

# ğŸš€ [ì¶”ê°€] Healthcheckì— í•„ìš”í•œ 'curl' ì„¤ì¹˜ (Debian ê¸°ë°˜)
# --no-install-recommendsë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ë¯¸ì§€ í¬ê¸°ë¥¼ ìµœì†Œí™”í•˜ê³  ë¶ˆí•„ìš”í•œ íŒŒì¼ ì •ë¦¬
RUN apt-get update && \
Â  Â  apt-get install -y curl --no-install-recommends && \
Â  Â  rm -rf /var/lib/apt/lists/*

# ê¸°ë³¸ webapps ì •ë¦¬
RUN rm -rf /usr/local/tomcat/webapps/*

# WAR íŒŒì¼ ë³µì‚¬ (ì •í™•í•œ íŒŒì¼ëª… ì‚¬ìš©)
COPY --from=builder /app/target/*.war /usr/local/tomcat/webapps/ROOT.war

# Tomcat í¬íŠ¸ë¥¼ 8888ë¡œ ë³€ê²½
RUN sed -i 's/port="8080"/port="8888"/g' /usr/local/tomcat/conf/server.xml

EXPOSE 8888

# ğŸš€ [ì¶”ê°€] ì»¨í…Œì´ë„ˆ Healthcheck ì •ì˜
# Spring Bootê°€ ì™„ì „íˆ ì‹œì‘ë  ë•Œê¹Œì§€ 60ì´ˆì˜ ì´ˆê¸° ëŒ€ê¸° ì‹œê°„(--start-period)ì„ ì¤ë‹ˆë‹¤.
# 30ì´ˆë§ˆë‹¤ ê²€ì‚¬í•˜ê³ , íƒ€ì„ì•„ì›ƒì€ 10ì´ˆë¡œ ì„¤ì •í•©ë‹ˆë‹¤. ì´ 5íšŒ ì‹¤íŒ¨ ì‹œ unhealthyë¡œ ê°„ì£¼í•©ë‹ˆë‹¤.
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=5 \
Â  CMD curl -f http://localhost:8888/actuator/health || exit 1

CMD ["catalina.sh", "run"]

